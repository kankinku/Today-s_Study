# 정산을 사람의 기억에서 시스템의 책임으로 이전하기 위한 MASS 설계 원칙과 결정론적 정산 구조

#정산시스템 #이벤트기반 #멱등성 #결정적계산  
작성일: 2026-01-24

---

## 1. 문제 정의 또는 한계 상황

정산 업무는 매월 반드시 마감되어야 하는 강제적 프로세스이면서도, 기존에는 사람의 판단과 수기 검증에 과도하게 의존해 왔다. 데이터는 물류·운영 시스템 전반에 분산되어 있고, 정산 기준은 시점과 상황에 따라 미세하게 달라지며, 한 번 계산된 결과조차 다시 신뢰하기 어려운 구조였다.  
이러한 환경에서는 다음과 같은 구조적 한계가 반복적으로 발생한다.

- 회계 마감이라는 절대적 데드라인 하에서 오류 허용치가 0에 가까움
    
- 엑셀 중심 검증과 재계산으로 인한 업무 병목과 휴먼 에러
    
- 과거 기준으로의 재계산 요구에 대한 체계적 대응 불가능
    

문제의 핵심은 “정산을 얼마나 빨리 하느냐”가 아니라, “정산 결과에 대해 누가 책임지는가”였다. 사람의 기억과 경험에 의존하는 방식은 재현성과 책임성을 동시에 만족시킬 수 없었다.

---

## 2. 도입된 기술 또는 구조

MASS(Musinsa Accounting & Settlement System)는 물류/운영 과정에서 발생하는 원천 이벤트를 수집해 파트너 정산을 자동화하는 시스템이다. 그러나 단순 자동화 도구가 아니라, 정산 결과에 대한 최종 기준(system of record)이 되는 것을 목표로 설계되었다.

이를 위해 MASS는 다음 역할을 수행하도록 구조화되었다.

- 입고/출고/반품/재고 이벤트 기반 원천 데이터 수집
    
- 단가·정책·조건을 기준으로 한 정산 금액 계산
    
- 일/월 단위 집계 및 마감 처리
    
- 내부 담당자와 외부 파트너가 동일 기준으로 결과를 확인하는 단일 기준 제공
    

이 구조의 핵심은 정산 행위를 “사후 검증 대상”이 아니라 “시스템이 보증하는 계산 결과”로 정의한 점이다.

---

## 3. 작동 메커니즘 (How)

### 3.1 이벤트 기반 수집과 멱등 처리

정산의 입력은 모두 이벤트 형태로 유입된다. 이벤트 기반 시스템에서는 중복 수신, 재시도, 재처리가 필연적이므로 MASS는 이를 예외가 아닌 전제로 둔다.

- 모든 이벤트는 업스트림에서 제공하는 고유 식별자를 기반으로 정산 도메인 트랜잭션 식별자를 구성
    
- 서비스 레벨에서 해당 식별자를 기준으로 이미 처리된 이벤트 여부를 판단
    
- 동일 이벤트가 여러 번 처리되어도 결과는 항상 동일(no-op 또는 정책에 따른 갱신)
    

DB 유니크 제약에 의존하지 않고 도메인 규칙으로 멱등성을 정의함으로써, 장애 상황에서도 안전한 재처리가 가능해진다.

### 3.2 Retry와 DLT의 분리

이벤트 실패를 일시적 실패와 구조적 실패로 구분한다.

- 네트워크 오류, 외부 의존성 문제 등은 Retry로 정상 흐름 복귀
    
- 반복 실패 이벤트는 정상 파이프라인에서 분리해 DLT(Dead Letter Topic)로 격리
    

이를 통해 시스템 전체의 처리 안정성을 유지하면서도, 문제 이벤트를 추적·분석 가능한 상태로 보존한다.

### 3.3 결정적 계산 구조

정산 계산 로직은 외부 상태에 의존하지 않는 결정적 구조로 설계된다.

- 계산기는 입력값만을 참조하는 순수 함수 형태
    
- 정산 기준일과 기준 유형은 SettlementContext로 명시적 전달
    
- 실행 시점, 서버 환경, 전역 상태를 참조하지 않음
    

동일한 입력과 컨텍스트가 주어지면 언제 실행해도 동일한 결과가 산출되도록 보장한다.

### 3.4 금액 스케일과 반올림 정책의 강제

정산 도메인에서 반올림은 표현 문제가 아니라 결과 자체를 바꾸는 규칙이다.  
MASS는 이를 명시적 정책으로 고정한다.

- 모든 금액 계산은 BigDecimal 사용
    
- 스케일(MONEY_SCALE) 고정
    
- 반올림 정책은 일관되게 RoundingMode.DOWN 적용
    

소수점이 발생하는 모든 지점에서 정책을 코드로 강제함으로써, 계산 경로·실행 환경·집계 단위가 달라져도 동일한 결과를 보장한다.

---

## 4. 선택의 이유 (Why)

이 설계는 다음과 같은 대안들의 한계를 전제로 선택되었다.

- 수기 + 엑셀 검증: 재현성과 책임 주체 불명확
    
- 단순 배치 계산: 기준 변경·재처리에 취약
    
- DB 제약 기반 중복 방지: 도메인 의미를 담지 못함
    

멱등성과 결정적 계산을 시스템 레벨에서 강제함으로써,  
정산 결과를 “사람이 검증하는 숫자”가 아니라 “시스템이 보증하는 결과”로 전환하는 것이 유일한 해결책이었다.

트레이드오프는 명확하다.  
초기 설계와 구현 복잡도는 증가하지만, 운영 단계에서의 오류 비용·재작업 비용·신뢰 비용을 구조적으로 제거한다는 판단이었다.

---

## 5. 구조적 시사점

MASS의 설계는 정산 도메인에 국한되지 않는다.

- 이벤트 기반 입력 + 멱등 처리 구조는 재무, 과금, 포인트, 정산 전반에 재사용 가능
    
- 결정적 계산과 컨텍스트 명시화는 감사 가능성과 재현성이 요구되는 모든 시스템에 적용 가능
    
- 반올림·스케일을 정책으로 고정하는 방식은 금액·수치 기반 시스템 전반에 일반화 가능
    

결과적으로 MASS는 “정산 시스템은 계산기가 아니라 기록과 책임의 시스템”이라는 전제를 구조로 구현한 사례다.  
정산이 다시 계산되어야 하는 현실을 받아들이고, 그 재계산을 사람의 기억이 아닌 시스템의 성질로 해결한 설계라 할 수 있다.